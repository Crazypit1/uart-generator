# UART Generator

**Генератор прямоугольных импульсов (меандра)** на базе ESP32-C3 с управлением по USB. Задаёте частоту и скважность с компьютера или любого терминала — на выходе получаете стабильный сигнал на GPIO. Удобно для проверки UART, настройки таймеров, тестов входов и т.п.

---

## Что это и зачем

- **Жёстко заданная частота** от 1 Гц до 40 МГц и **скважность** 0–100%.
- **Управление по COM-порту** (USB CDC): одна команда — один ответ, текстовый протокол.
- **Один USB-кабель**: питание и данные (подходит плата с USB, например ESP32-C3-DevKitM-1).
- **Выход** — GPIO 5 (аппаратный ШИМ/LEDC), можно подключать к другому устройству или измерителю.

Подходит для: отладки приёма по UART на разных скоростях, калибровки таймеров, проверки счётчиков импульсов, простых тестов «есть ли сигнал».

---

## Оборудование

| Параметр | Значение |
|----------|----------|
| **Плата** | ESP32-C3 с USB (например **ESP32-C3-DevKitM-1**) |
| **Выход сигнала** | **GPIO 5** (3.3 V, меандр) |
| **Связь с ПК** | USB (виртуальный COM-порт, 115200 бод) |

Дополнительно: USB-кабель для подключения к компьютеру. Для выхода — при необходимости резистор/буфер под вашу нагрузку.

---

## Быстрый старт

1. **Собрать и прошить** прошивку (см. раздел «Сборка и прошивка»).
2. Подключить плату по USB — в системе появится новый COM-порт.
3. **Либо** запустить GUI (раздел «Программа на ПК (GUI)») и управлять с окна.  
   **Либо** открыть любой терминал (PuTTY, Arduino Serial Monitor, `pio device monitor`) на 115200 бод и вводить команды вручную.

---

## Сборка и прошивка

Нужны: [PlatformIO](https://platformio.org/) (CLI или расширение для VS Code / Cursor).

В корне проекта:

```bash
# Сборка
pio run -e esp32c3_arduino

# Загрузка прошивки в плату (плата подключена по USB)
pio run -e esp32c3_arduino -t upload

# Монитор порта (просмотр ответов устройства)
pio device monitor -e esp32c3_arduino -b 115200
```

Используется окружение **esp32c3_arduino** (Arduino + ESP32-C3, USB CDC). После прошивки при подключении по USB устройство отвечает на команды по протоколу ниже.

---

## Программа на ПК (GUI)

Графическое приложение (Python): выбор COM-порта, подключение, установка частоты и скважности, включение/выключение выхода.

### Установка

```bash
cd gui
pip install -r requirements.txt
```

Требуются: Python 3.8+, `pyserial`, `customtkinter`.

### Запуск

```bash
python generator_gui.py
```

Или двойной клик по `generator_gui.py`, если Python в PATH.

### Как пользоваться

1. Подключите ESP32-C3 по USB.
2. В программе нажмите **«Обновить»** — в списке появятся порты, на которых найден генератор (по ответу на `VER?`). Если список пустой — проверьте кабель и драйвер COM-порта.
3. Выберите порт и нажмите **«Подключить»**.
4. Задайте **частоту (Гц)** в поле и нажмите **«Применить»**, при необходимости измените **скважность (%)** слайдером и снова **«Применить»**.
5. **«Включить выход»** / **«Выключить выход»** — подача или снятие сигнала с GPIO 5.
6. **«Запросить статус»** — обновить отображаемые частота, скважность и состояние выхода с устройства.

При отключении кабеля программа перейдёт в «Не подключено»; список портов автоматически обновляется каждые несколько секунд, после повторного подключения генератор снова появится в списке.

Подробнее по GUI: [gui/README.md](gui/README.md).

---

## Управление из терминала (ручные команды)

Скорость: **115200** бод, 8N1. Команды отправляются строками (завершение переводом строки). Ответы заканчиваются `\r\n`.

### Команды протокола

| Команда | Описание | Пример ответа |
|--------|----------|----------------|
| `VER?` или `ID?` | Идентификация устройства | `UART-GEN,1.0` |
| `FREQ <число>` | Установить частоту в герцах (1 … 40 000 000) | `OK FREQ 1000` |
| `DUTY <0-100>` | Установить скважность в процентах | `OK DUTY 50` |
| `ON` или `START` | Включить выход (меандр на GPIO 5) | `OK ON` |
| `OFF` или `STOP` | Выключить выход | `OK OFF` |
| `?` или `STATUS` | Текущие частота, скважность и состояние выхода | `FREQ=1000 DUTY=50 ON` |
| `HELP` | Краткая справка по командам | Текст справки |

### Пример сеанса в терминале

```
VER?
UART-GEN,1.0

FREQ 5000
OK FREQ 5000

DUTY 25
OK DUTY 25

ON
OK ON

?
FREQ=5000 DUTY=25 ON

OFF
OK OFF
```

Частоту можно указывать в десятичном виде или, при поддержке терминала, в hex (например `0x1000`). Ошибки приходят строками вида `ERR ...`.

---

## Частые вопросы и проблемы

- **Порт не появляется после подключения**  
  Убедитесь, что прошивка собрана с флагами `ARDUINO_USB_CDC_ON_BOOT=1` и `ARDUINO_USB_MODE=1` (в `platformio.ini` это уже задано). На Windows может потребоваться драйвер USB CDC (часто ставится автоматически).

- **Генератор не находится при «Обновить» в GUI**  
  Подождите 2–3 секунды после подключения (устройство успевает подняться). Проверьте, что порт не занят другой программой (закройте монитор порта PlatformIO/Arduino IDE).

- **После отключения и повторного подключения USB порт не появляется**  
  В прошивке включён обработчик USB BUS_RESET: при повторном подключении кабеля Serial переинициализируется. Если проблема остаётся — перезагрузите плату (кнопка Reset или отключение питания).

- **Нужен другой GPIO**  
  В `src/main_arduino.cpp` измените константу `GENERATOR_PIN` (сейчас 5), пересоберите и прошейте.

---

## Структура репозитория

```
├── src/
│   ├── main_arduino.cpp   # Прошивка Arduino для ESP32-C3 (основная)
│   ├── main.cpp           # Заготовка под ESP-IDF
│   └── ...
├── include/
├── gui/                   # Программа управления (Python)
│   ├── generator_gui.py   # Окно управления
│   ├── protocol.py        # Протокол и опрос портов
│   ├── requirements.txt
│   └── README.md
├── platformio.ini         # Окружения сборки
├── README.md
└── LICENSE
```

---

## Лицензия

MIT — см. [LICENSE](LICENSE).
